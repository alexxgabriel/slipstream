name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener c√≥digo y subm√≥dulos
    - name: Obtener c√≥digo con subm√≥dulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Instalar herramientas NATIVAS para ARM (NO cross-compile)
    - name: Instalar compilador nativo ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          meson \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          libssl-dev:armhf

    # 3. Compilar NATIVAMENTE para ARM
    - name: Compilar nativamente para ARM
      run: |
        echo "=== Configurando build NATIVO para ARM ==="
        
        # Configurar con Meson para ARM
        CC=arm-linux-gnueabi-gcc CXX=arm-linux-gnueabi-g++ meson setup build-arm \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=release \
          -Dc_args="-march=armv7-a -DOPENSSL_NO_ASM" \
          -Dcpp_args="-march=armv7-a"
        
        echo "=== Compilando ==="
        meson compile -C build-arm
        
        echo "=== Buscando binarios ==="
        find build-arm/ -type f -executable -name "*slipstream*" || find build-arm/ -type f -executable

    # 4. Copiar binarios encontrados
    - name: Copiar binarios a ra√≠z
      run: |
        echo "=== Copiando binarios ==="
        
        # Buscar cliente
        if find build-arm/ -type f -executable -name "*client*" | grep -q .; then
          CLIENT=$(find build-arm/ -type f -executable -name "*client*" | head -1)
          cp "$CLIENT" slipstream-client
          chmod +x slipstream-client
          echo "‚úÖ slipstream-client copiado"
          file slipstream-client
        fi
        
        # Buscar servidor
        if find build-arm/ -type f -executable -name "*server*" | grep -q .; then
          SERVER=$(find build-arm/ -type f -executable -name "*server*" | head -1)
          cp "$SERVER" slipstream-server
          chmod +x slipstream-server
          echo "‚úÖ slipstream-server copiado"
          file slipstream-server
        fi
        
        # Si no hay nombres espec√≠ficos, copiar primeros ejecutables
        if [ ! -f "slipstream-client" ] && [ ! -f "slipstream-server" ]; then
          EXES=$(find build-arm/ -type f -executable | head -2)
          i=0
          for exe in $EXES; do
            if [ $i -eq 0 ]; then
              cp "$exe" slipstream-client
              chmod +x slipstream-client
              echo "üì¶ slipstream-client: $exe"
            elif [ $i -eq 1 ]; then
              cp "$exe" slipstream-server
              chmod +x slipstream-server
              echo "üì¶ slipstream-server: $exe"
            fi
            ((i++))
          done
        fi

    # 5. Subir binarios
    - name: Subir binarios al repositorio
      if: success()
      run: |
        if [ ! -f "slipstream-client" ] && [ ! -f "slipstream-server" ]; then
          echo "‚ö†Ô∏è  No hay binarios para subir"
          exit 0
        fi
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        [ -f "slipstream-client" ] && git add slipstream-client
        [ -f "slipstream-server" ] && git add slipstream-server
        
        if ! git diff --cached --quiet; then
          git commit -m "‚öôÔ∏è  Binarios ARM32 nativos [ci skip]"
          git push
          echo "‚úÖ Binarios subidos"
        fi
