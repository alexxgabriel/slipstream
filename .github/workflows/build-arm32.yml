name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener código y submódulos
    - name: Obtener código con submódulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # 2. INSTALACIÓN CORREGIDA
    - name: Instalar herramientas para compilar en ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          meson \
          ninja-build \
          cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          pkg-config \
          libssl-dev

    # 3. DEBUG DEL ENTORNO (NUEVO)
    - name: Debug del entorno
      run: |
        echo "=== VERIFICACIÓN DEL ENTORNO ==="
        echo "1. Verificando compilador ARM:"
        arm-linux-gnueabi-gcc --version || echo "❌ Compilador no disponible"
        
        echo ""
        echo "2. Verificando OpenSSL:"
        find /usr -name "opensslconf.h" 2>/dev/null | head -5
        
        echo ""
        echo "3. Probando compilación simple con OpenSSL:"
        cat > test_ssl.c << 'EOF'
        #include <openssl/ssl.h>
        int main() { return 0; }
        EOF
        
        # Probar con diferentes rutas
        for INCLUDE_PATH in "/usr/include" "/usr/arm-linux-gnueabi/include" "/usr/local/include"; do
          echo "Probando con -I$INCLUDE_PATH"
          arm-linux-gnueabi-gcc -march=armv7-a -I$INCLUDE_PATH -c test_ssl.c -o /dev/null 2>&1 && echo "✅ Funciona" || echo "❌ Falló"
        done

    # 4. Parchear archivos para quitar -Werror
    - name: Parchear archivos para quitar -Werror
      run: |
        echo "=== Parcheando archivos ==="
        
        # Método DIRECTO: Buscar archivos específicos de picoquic
        find . -path "*/picoquic/*" -name "CMakeLists.txt" | while read file; do
          echo "Parcheando: $file"
          sed -i 's/-Werror//g; s/add_compile_options.*-Werror.*//g' "$file"
        done
        
        # Parchear también archivos .cmake
        find . -path "*/picoquic/*" -name "*.cmake" | while read file; do
          echo "Parcheando: $file"
          sed -i 's/-Werror//g' "$file"
        done

    # 5. Configurar con Meson (CORREGIDO)
    - name: Configurar con Meson
      run: |
        echo "=== Configurando con Meson ==="
        
        # Crear archivo de cross-compilación SIMPLE
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [properties]
        c_args = ['-march=armv7-a', '-w', '-I/usr/include']
        cpp_args = ['-march=armv7-a', '-w', '-I/usr/include']
        EOF
        
        # Configurar con opciones MÍNIMAS
        meson setup build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug

    # 6. Compilar proyecto
    - name: Compilar proyecto
      run: |
        echo "=== Compilando ==="
        
        # Intentar compilar
        if meson compile -C build; then
          echo "✅ Compilación exitosa"
        else
          echo "⚠️  Primero intento falló, intentando con ninja directamente..."
          cd build && ninja -k 5 || echo "Continuando..."
        fi

    # 7. Verificar resultado
    - name: Verificar binarios
      run: |
        echo "=== Verificando binarios ==="
        
        if [ -f "build/slipstream-client" ]; then
          echo "✅ slipstream-client creado"
          echo "=== ARQUITECTURA ==="
          file build/slipstream-client
          
          # Crear paquete simple
          mkdir -p slipstream-bin
          cp build/slipstream-client slipstream-bin/
          [ -f "build/slipstream-server" ] && cp build/slipstream-server slipstream-bin/
          
          tar -czf slipstream-arm32.tar.gz slipstream-bin/
          echo "✅ Paquete creado"
        else
          echo "❌ No se pudo crear slipstream-client"
          echo "=== ÚLTIMOS ERRORES ==="
          tail -100 build/meson-logs/meson-log.txt
          exit 1
        fi

    # 8. Subir binarios
    - name: Subir binarios
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-arm32
        path: |
          slipstream-arm32.tar.gz
        retention-days: 90
