
name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener cÃ³digo y submÃ³dulos
    - name: Obtener cÃ³digo con submÃ³dulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Instalar herramientas
    - name: Instalar herramientas para compilar en ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          pkg-config \
          libssl-dev \
          python3-pip

    # 3. Instalar Meson actualizado
    - name: Instalar Meson actualizado
      run: |
        pip3 install --upgrade pip
        pip3 install meson==1.4.0

    # 4. Parchear archivos para quitar -Werror
    - name: Parchear archivos para quitar -Werror
      run: |
        find . -path "*/picoquic/*" -name "CMakeLists.txt" | while read file; do
          sed -i 's/-Werror//g; s/add_compile_options.*-Werror.*//g' "$file"
        done

    # 5. Configurar con Meson (usando el meson.build existente)
    - name: Configurar con Meson
      run: |
        echo "=== Configurando con Meson (usando meson.build original) ==="
        
        # Primero mostrar el meson.build original
        echo "=== MESON.BUILD ORIGINAL ==="
        head -50 meson.build || echo "No hay meson.build en raÃ­z"
        
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        ar = 'arm-linux-gnueabi-ar'
        strip = 'arm-linux-gnueabi-strip'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [built-in options]
        c_args = ['-march=armv7-a', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        cpp_args = ['-march=armv7-a', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        EOF
        
        meson setup build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug

    # 6. DEBUG: Ver quÃ© va a compilar Meson
    - name: Ver targets de compilaciÃ³n
      run: |
        echo "=== TARGETS DEFINIDOS ==="
        meson introspect --targets build/ || echo "No se pueden ver targets"
        
        echo ""
        echo "=== INFORMACIÃ“N DEL PROYECTO ==="
        meson introspect --projectinfo build/ 2>/dev/null || echo "No hay info"

    # 7. Compilar proyecto
    - name: Compilar proyecto
      run: |
        echo "=== Compilando ==="
        meson compile -C build

    # 8. BUSCAR BINARIOS GENERADOS (flexible)
    - name: Buscar y copiar binarios
      run: |
        echo "=== BUSCANDO BINARIOS EN build/ ==="
        
        # 1. Primero mostrar estructura
        echo "Estructura completa:"
        find build/ -type f -executable 2>/dev/null || echo "No hay ejecutables"
        
        # 2. Buscar archivos comunes
        echo ""
        echo "Buscando archivos especÃ­ficos..."
        
        # Crear array de nombres posibles
        declare -a possible_names=(
          "slipstream-client" "slipstream_client" "client" "slipstream"
          "slipstream-server" "slipstream_server" "server"
        )
        
        # Buscar cada nombre
        for name in "${possible_names[@]}"; do
          echo ""
          echo "Buscando: $name"
          find build/ -type f \( -executable -o -name "*${name}*" \) 2>/dev/null | while read file; do
            echo "Encontrado: $file"
            
            # Determinar si es cliente o servidor
            if [[ "$file" == *"client"* ]] || [[ "$name" == *"client"* ]]; then
              cp "$file" slipstream-client 2>/dev/null && echo "  â†’ Copiado como slipstream-client"
              chmod +x slipstream-client 2>/dev/null
            fi
            
            if [[ "$file" == *"server"* ]] || [[ "$name" == *"server"* ]]; then
              cp "$file" slipstream-server 2>/dev/null && echo "  â†’ Copiado como slipstream-server"
              chmod +x slipstream-server 2>/dev/null
            fi
          done
        done
        
        # 3. Si no encontramos, copiar cualquier ejecutable
        if [ ! -f "slipstream-client" ]; then
          echo ""
          echo "No se encontrÃ³ cliente especÃ­fico, buscando cualquier ejecutable..."
          FIRST_EXE=$(find build/ -type f -executable 2>/dev/null | head -1)
          if [ -n "$FIRST_EXE" ]; then
            cp "$FIRST_EXE" slipstream-client
            chmod +x slipstream-client
            echo "Copiado '$FIRST_EXE' como slipstream-client"
          fi
        fi
        
        # 4. Verificar resultado
        echo ""
        echo "=== RESULTADO FINAL ==="
        if [ -f "slipstream-client" ] || [ -f "slipstream-server" ]; then
          echo "âœ… Binarios encontrados:"
          [ -f "slipstream-client" ] && echo "  slipstream-client: $(file slipstream-client)"
          [ -f "slipstream-server" ] && echo "  slipstream-server: $(file slipstream-server)"
        else
          echo "âŒ No se encontraron binarios"
          echo "=== ÃšLTIMO RESORTE: Listar TODO en build/ ==="
          find build/ -type f | head -50
          exit 1
        fi

    # 9. Subir binarios al repositorio
    - name: Subir binarios al repositorio
      if: success()
      run: |
        # Solo continuar si tenemos binarios
        if [ ! -f "slipstream-client" ] && [ ! -f "slipstream-server" ]; then
          echo "No hay binarios para subir"
          exit 0
        fi
        
        # Configurar Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # Agregar binarios (ignorar errores si no existen)
        git add slipstream-client 2>/dev/null || true
        git add slipstream-server 2>/dev/null || true
        
        # Commit si hay cambios
        if ! git diff --cached --quiet; then
          git commit -m "ðŸ“¦ Actualizar binarios ARM32 [ci skip]"
          git push
          echo "âœ… Binarios subidos al repositorio"
        else
          echo "âœ… Binarios ya estÃ¡n actualizados"
        fi

    # 10. (Opcional) Subir como artifact
    - name: Subir como artifact
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-arm32
        path: |
          slipstream-client
          slipstream-server
        retention-days: 90
