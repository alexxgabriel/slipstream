name: Build slipstream for ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # PASO CRÍTICO: Instalar OpenSSL para ARM
    - name: Install ARM cross-compiler and OpenSSL
      run: |
        sudo apt-get update
        # 1. Instalar el compilador cruzado
        sudo apt-get install -y \
          meson ninja-build cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi
        
        # 2. Instalar OpenSSL para ARM (ESTO FALTA EN TU CONFIG)
        sudo apt-get install -y \
          libssl-dev:armhf \
          libssl-dev
        
        # 3. Configurar rutas para pkg-config
        echo "PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabi/pkgconfig" >> $GITHUB_ENV
        echo "PKG_CONFIG_SYSROOT_DIR=/" >> $GITHUB_ENV

    - name: Patch to remove -Werror
      run: |
        find . -type f \( -name "CMakeLists.txt" -o -name "*.cmake" \) -exec sed -i 's/-Werror//g' {} \;

    # PASO CRÍTICO: Verificar que OpenSSL existe para ARM
    - name: Verify OpenSSL for ARM
      run: |
        echo "Buscando opensslconf.h para ARM..."
        find /usr -name "opensslconf.h" 2>/dev/null | head -5
        echo ""
        echo "Probando compilación con OpenSSL..."
        arm-linux-gnueabi-gcc -march=armv7-a -x c -c - <<<'#include <openssl/ssl.h>' -o /dev/null && echo "✅ OpenSSL funciona" || echo "❌ OpenSSL falla"

    - name: Configure with Meson
      env:
        CC: arm-linux-gnueabi-gcc
        CXX: arm-linux-gnueabi-g++
        CFLAGS: "-march=armv7-a -w"
        CXXFLAGS: "-march=armv7-a -w"
      run: |
        # Crear archivo de cross-compilación DINÁMICO
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        ar = 'arm-linux-gnueabi-ar'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [properties]
        pkg_config_path = '/usr/lib/arm-linux-gnueabi/pkgconfig'
        EOF
        
        meson setup build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug

    - name: Compile with Ninja
      run: |
        # Compilar ignorando algunos errores
        meson compile -C build -j2 || true
        # Intentar continuar a pesar de errores
        cd build && ninja -k 5

    - name: Check for successful build
      run: |
        if [ -f "build/slipstream-client" ]; then
          echo "✅ Binario creado exitosamente"
          file build/slipstream-client
        else
          echo "❌ Compilación falló, mostrando errores:"
          tail -100 build/meson-logs/meson-log.txt
          exit 1
        fi

    - name: Upload binaries
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-arm32-binaries
        path: |
          build/slipstream-client
          build/slipstream-server
        retention-days: 90
