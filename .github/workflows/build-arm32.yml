name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener c√≥digo y subm√≥dulos
    - name: Obtener c√≥digo con subm√≥dulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Instalar herramientas
    - name: Instalar herramientas para compilar en ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          pkg-config \
          libssl-dev \
          python3-pip

    # 3. Instalar Meson actualizado
    - name: Instalar Meson actualizado
      run: |
        pip3 install --upgrade pip
        pip3 install meson==1.4.0

    # 4. Parchear archivos para quitar -Werror
    - name: Parchear archivos para quitar -Werror
      run: |
        find . -path "*/picoquic/*" -name "CMakeLists.txt" | while read file; do
          sed -i 's/-Werror//g; s/add_compile_options.*-Werror.*//g' "$file"
        done

    # 5. Configurar con Meson
    - name: Configurar con Meson
      run: |
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        ar = 'arm-linux-gnueabi-ar'
        strip = 'arm-linux-gnueabi-strip'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [built-in options]
        c_args = ['-march=armv7-a', '-w', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        cpp_args = ['-march=armv7-a', '-w', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        EOF
        
        meson setup build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug

    # 6. Compilar proyecto
    - name: Compilar proyecto
      run: |
        meson compile -C build

    # 7. ENCONTRAR Y RENOMBRAR BINARIOS (PASO CLAVE)
    - name: Buscar y preparar binarios
      run: |
        echo "=== BUSCANDO BINARIOS EN build/ ==="
        
        # Mostrar estructura para debug
        echo "Estructura de build/:"
        find build/ -type f -executable 2>/dev/null
        
        # Buscar binarios (probables nombres)
        CLIENT_FOUND=""
        SERVER_FOUND=""
        
        # Posibles nombres del cliente
        for name in "slipstream-client" "client" "slipstream" "main" "app"; do
          for file in $(find build/ -type f -executable -name "*${name}*" 2>/dev/null); do
            if [ -z "$CLIENT_FOUND" ]; then
              CLIENT_FOUND="$file"
              echo "‚úÖ Cliente encontrado: $file"
            fi
          done
        done
        
        # Posibles nombres del servidor
        for name in "slipstream-server" "server"; do
          for file in $(find build/ -type f -executable -name "*${name}*" 2>/dev/null); do
            if [ -z "$SERVER_FOUND" ]; then
              SERVER_FOUND="$file"
              echo "‚úÖ Servidor encontrado: $file"
            fi
          done
        done
        
        # Si no encontramos, tomar el primer ejecutable como cliente
        if [ -z "$CLIENT_FOUND" ] && [ -n "$(find build/ -type f -executable 2>/dev/null | head -1)" ]; then
          CLIENT_FOUND=$(find build/ -type f -executable 2>/dev/null | head -1)
          echo "‚ö†Ô∏è  Usando primer ejecutable como cliente: $CLIENT_FOUND"
        fi
        
        # Copiar y renombrar a nombres est√°ndar
        if [ -n "$CLIENT_FOUND" ]; then
          cp "$CLIENT_FOUND" slipstream-client
          echo "‚úÖ slipstream-client creado"
          file slipstream-client
        else
          echo "‚ùå No se encontr√≥ ning√∫n binario para el cliente"
          exit 1
        fi
        
        if [ -n "$SERVER_FOUND" ]; then
          cp "$SERVER_FOUND" slipstream-server
          echo "‚úÖ slipstream-server creado"
          file slipstream-server
        else
          echo "‚ö†Ô∏è  No se encontr√≥ binario para el servidor, solo cliente"
        fi

    # 8. Subir binarios al repositorio (REEMPLAZANDO LOS EXISTENTES)
    - name: Subir binarios al repositorio
      run: |
        # Configurar Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # Agregar los binarios
        git add slipstream-client slipstream-server
        
        # Verificar cambios
        if git diff --cached --quiet; then
          echo "No hay cambios en los binarios"
        else
          # Hacer commit
          git commit -m "üîÑ Actualizar binarios ARM32 compilados [ci skip]"
          
          # Hacer push
          git push
          echo "‚úÖ Binarios subidos al repositorio"
        fi

    # 9. (Opcional) Crear release
    - name: Crear Release con binarios
      if: success() && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        name: "Slipstream ARM32 v${{ github.run_number }}"
        tag_name: "arm32-v${{ github.run_number }}"
        files: |
          slipstream-client
          slipstream-server
        draft: false
        prerelease: false
