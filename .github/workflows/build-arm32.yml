name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener cÃ³digo y submÃ³dulos
    - name: Obtener cÃ³digo con submÃ³dulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Instalar herramientas
    - name: Instalar herramientas para compilar en ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          pkg-config \
          libssl-dev \
          python3-pip

    # 3. Instalar Meson actualizado
    - name: Instalar Meson actualizado
      run: |
        pip3 install --upgrade pip
        pip3 install meson==1.4.0

    # 4. Parchear archivos para quitar -Werror
    - name: Parchear archivos para quitar -Werror
      run: |
        find . -path "*/picoquic/*" -name "CMakeLists.txt" | while read file; do
          sed -i 's/-Werror//g; s/add_compile_options.*-Werror.*//g' "$file"
        done

    # 5. Configurar con Meson
    - name: Configurar con Meson
      run: |
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        ar = 'arm-linux-gnueabi-ar'
        strip = 'arm-linux-gnueabi-strip'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [built-in options]
        c_args = ['-march=armv7-a', '-w', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        cpp_args = ['-march=armv7-a', '-w', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        EOF
        
        meson setup meson-build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug

    # 6. Compilar proyecto
    - name: Compilar proyecto
      run: |
        meson compile -C meson-build

    # 7. Buscar y mover binarios a build/arm32/
    - name: Buscar y organizar binarios
      run: |
        echo "=== BUSCANDO BINARIOS EN meson-build/ ==="
        
        # Crear directorio para binarios finales
        mkdir -p build/arm32
        
        # Mostrar estructura para debug
        echo "Estructura de meson-build/:"
        find meson-build/ -type f -executable 2>/dev/null || echo "No hay ejecutables"
        
        # Buscar binarios del cliente
        CLIENT_FOUND=""
        for pattern in "*slipstream-client*" "*client*" "*slipstream*" "*main*" "*app*"; do
          for file in $(find meson-build/ -type f -executable -name "$pattern" 2>/dev/null); do
            if [ -z "$CLIENT_FOUND" ]; then
              CLIENT_FOUND="$file"
              echo "âœ… Cliente encontrado: $file"
            fi
          done
        done
        
        # Buscar binarios del servidor
        SERVER_FOUND=""
        for pattern in "*slipstream-server*" "*server*"; do
          for file in $(find meson-build/ -type f -executable -name "$pattern" 2>/dev/null); do
            if [ -z "$SERVER_FOUND" ]; then
              SERVER_FOUND="$file"
              echo "âœ… Servidor encontrado: $file"
            fi
          done
        done
        
        # Si no encontramos especÃ­ficos, buscar cualquier ejecutable
        if [ -z "$CLIENT_FOUND" ] && [ -n "$(find meson-build/ -type f -executable 2>/dev/null | head -1)" ]; then
          CLIENT_FOUND=$(find meson-build/ -type f -executable 2>/dev/null | head -1)
          echo "âš ï¸  Usando primer ejecutable como cliente: $CLIENT_FOUND"
        fi
        
        # Mover binarios a build/arm32/ con nombres estÃ¡ndar
        if [ -n "$CLIENT_FOUND" ]; then
          cp "$CLIENT_FOUND" build/arm32/slipstream-client
          echo "âœ… slipstream-client copiado a build/arm32/"
          echo "=== VERIFICACIÃ“N ==="
          file build/arm32/slipstream-client
          chmod +x build/arm32/slipstream-client
        else
          echo "âŒ No se encontrÃ³ ningÃºn binario para el cliente"
          find meson-build/ -type f | head -20
          exit 1
        fi
        
        if [ -n "$SERVER_FOUND" ]; then
          cp "$SERVER_FOUND" build/arm32/slipstream-server
          echo "âœ… slipstream-server copiado a build/arm32/"
          file build/arm32/slipstream-server
          chmod +x build/arm32/slipstream-server
        fi
        
        # Crear README
        cat > build/arm32/README.md << 'EOF'
        # Binarios Slipstream para ARM32
        
        ## Archivos:
        EOF
        
        for bin in build/arm32/*; do
          if [ -f "$bin" ] && [ "$(basename "$bin")" != "README.md" ]; then
            echo "- **$(basename "$bin")**: $(file "$bin" | cut -d: -f2-)" >> build/arm32/README.md
          fi
        done
        
        cat >> build/arm32/README.md << 'EOF'
        
        ## CÃ³mo usar:
        1. Copia los binarios a tu dispositivo ARM (Raspberry Pi, etc.)
        2. Hazlos ejecutables: `chmod +x slipstream-*`
        3. Ejecuta: `./slipstream-client` o `./slipstream-server`
        
        ## Compilado automÃ¡ticamente por GitHub Actions
        Fecha: $(date)
        Commit: ${{ github.sha }}
        EOF
        
        echo "=== BINARIOS LISTOS EN build/arm32/ ==="
        ls -la build/arm32/

    # 8. Subir binarios al repositorio
    - name: Subir binarios al repositorio
      run: |
        # Configurar Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # Agregar carpeta build/arm32/
        git add build/
        
        # Verificar cambios
        if git diff --cached --quiet; then
          echo "No hay cambios en los binarios"
        else
          # Hacer commit
          git commit -m "ðŸ“¦ Actualizar binarios ARM32 en build/arm32/ [ci skip]"
          
          # Hacer push
          git push
          echo "âœ… Binarios subidos a build/arm32/"
        fi

    # 9. Crear artifact para descarga
    - name: Crear artifact descargable
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-arm32
        path: |
          build/arm32/
        retention-days: 90

    # 10. (Opcional) Crear release
    - name: Crear Release
      if: success() && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        name: "Slipstream ARM32 v${{ github.run_number }}"
        tag_name: "arm32-v${{ github.run_number }}"
        files: |
          build/arm32/slipstream-client
          build/arm32/slipstream-server
          build/arm32/README.md
        draft: false
        prerelease: false
        generate_release_notes: true
