name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener c√≥digo y subm√≥dulos
    - name: Obtener c√≥digo con subm√≥dulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. Instalar herramientas CON OPENSSL PARA ARM
    - name: Instalar herramientas para compilar en ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          pkg-config \
          python3-pip \
          libssl-dev:armhf \
          libssl-dev

    # 3. Instalar Meson actualizado
    - name: Instalar Meson actualizado
      run: |
        pip3 install --upgrade pip
        pip3 install meson==1.4.0

    # 4. Parchear archivos para quitar -Werror
    - name: Parchear archivos para quitar -Werror
      run: |
        find . -path "*/picoquic/*" -name "CMakeLists.txt" | while read file; do
          sed -i 's/-Werror//g; s/add_compile_options.*-Werror.*//g' "$file"
        done

    # 5. Configurar con Meson (CON OPENSSL CORREGIDO)
    - name: Configurar con Meson
      run: |
        echo "=== Configurando con Meson ==="
        
        # Buscar headers de OpenSSL para ARM
        echo "Buscando OpenSSL para ARM..."
        find /usr -name "opensslconf.h" 2>/dev/null
        
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        ar = 'arm-linux-gnueabi-ar'
        strip = 'arm-linux-gnueabi-strip'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [built-in options]
        c_args = [
          '-march=armv7-a',
          '-I/usr/include',
          '-I/usr/arm-linux-gnueabi/include',
          '-DOPENSSL_NO_ASM'  # Desactiva ASM espec√≠fico de arquitectura
        ]
        cpp_args = [
          '-march=armv7-a',
          '-I/usr/include',
          '-I/usr/arm-linux-gnueabi/include'
        ]
        EOF
        
        echo "=== Archivo de cross-compilaci√≥n ==="
        cat cross-arm.txt
        
        meson setup build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug \
          -Dc_args="-DOPENSSL_NO_ASM"

    # 6. Compilar proyecto
    - name: Compilar proyecto
      run: |
        echo "=== Compilando ==="
        meson compile -C build

    # 7. Buscar y copiar binarios
    - name: Buscar y copiar binarios
      run: |
        echo "=== BUSCANDO BINARIOS ==="
        
        # Mostrar estructura
        echo "Contenido de build/:"
        find build/ -type f -executable 2>/dev/null || echo "No hay ejecutables"
        
        # Buscar binarios espec√≠ficos
        echo ""
        echo "Buscando slipstream-client..."
        CLIENT=$(find build/ -type f \( -name "slipstream-client" -o -name "*client*" \) -executable 2>/dev/null | head -1)
        
        echo ""
        echo "Buscando slipstream-server..."
        SERVER=$(find build/ -type f \( -name "slipstream-server" -o -name "*server*" \) -executable 2>/dev/null | head -1)
        
        # Copiar si se encontraron
        if [ -n "$CLIENT" ]; then
          echo "‚úÖ Cliente encontrado: $CLIENT"
          cp "$CLIENT" slipstream-client
          chmod +x slipstream-client
          echo "=== VERIFICACI√ìN CLIENTE ==="
          file slipstream-client
        else
          echo "‚ùå No se encontr√≥ cliente"
        fi
        
        if [ -n "$SERVER" ]; then
          echo "‚úÖ Servidor encontrado: $SERVER"
          cp "$SERVER" slipstream-server
          chmod +x slipstream-server
          echo "=== VERIFICACI√ìN SERVIDOR ==="
          file slipstream-server
        else
          echo "‚ö†Ô∏è  No se encontr√≥ servidor"
        fi
        
        # Si no se encontr√≥ nada, buscar cualquier ejecutable
        if [ ! -f "slipstream-client" ]; then
          echo ""
          echo "Buscando cualquier ejecutable..."
          ANY_EXE=$(find build/ -type f -executable 2>/dev/null | head -1)
          if [ -n "$ANY_EXE" ]; then
            cp "$ANY_EXE" slipstream-client
            chmod +x slipstream-client
            echo "‚úÖ Copiado como slipstream-client: $ANY_EXE"
            file slipstream-client
          fi
        fi
        
        echo ""
        echo "=== BINARIOS FINALES ==="
        ls -la slipstream-* 2>/dev/null || echo "No se crearon binarios"

    # 8. Subir binarios al repositorio
    - name: Subir binarios al repositorio
      if: success()
      run: |
        # Solo si hay binarios
        if [ ! -f "slipstream-client" ] && [ ! -f "slipstream-server" ]; then
          echo "‚ö†Ô∏è  No hay binarios para subir"
          exit 0
        fi
        
        # Configurar Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # Agregar binarios
        [ -f "slipstream-client" ] && git add slipstream-client
        [ -f "slipstream-server" ] && git add slipstream-server
        
        # Commit si hay cambios
        if ! git diff --cached --quiet; then
          git commit -m "üì¶ Actualizar binarios ARM32 [ci skip]"
          git push
          echo "‚úÖ Binarios subidos al repositorio"
        else
          echo "‚úÖ Binarios ya est√°n actualizados"
        fi

    # 9. Subir como artifact
    - name: Subir como artifact
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-arm32
        path: |
          slipstream-client
          slipstream-server
        retention-days: 90
