name: Compilar slipstream para ARM 32-bit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # 1. Obtener código y submódulos
    - name: Obtener código con submódulos
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # 2. INSTALACIÓN CORREGIDA
    - name: Instalar herramientas para compilar en ARM
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          cmake \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi \
          binutils-arm-linux-gnueabi \
          pkg-config \
          libssl-dev \
          python3-pip

    # 3. INSTALAR MESON ACTUALIZADO
    - name: Instalar Meson actualizado
      run: |
        echo "=== Instalando Meson 1.4.0 ==="
        pip3 install --upgrade pip
        pip3 install meson==1.4.0
        echo "Versión de Meson instalada:"
        meson --version

    # 4. DEBUG DEL ENTORNO
    - name: Debug del entorno
      run: |
        echo "=== VERIFICACIÓN DEL ENTORNO ==="
        echo "1. Verificando compilador ARM:"
        arm-linux-gnueabi-gcc --version || echo "❌ Compilador no disponible"
        
        echo ""
        echo "2. Verificando strip binary:"
        which arm-linux-gnueabi-strip || echo "Strip no encontrado, instalando..."
        sudo apt-get install -y binutils-arm-linux-gnueabi
        
        echo ""
        echo "3. Verificando OpenSSL:"
        find /usr -name "opensslconf.h" 2>/dev/null | head -5

    # 5. Parchear archivos para quitar -Werror
    - name: Parchear archivos para quitar -Werror
      run: |
        echo "=== Parcheando archivos ==="
        
        # Método DIRECTO: Buscar archivos específicos de picoquic
        find . -path "*/picoquic/*" -name "CMakeLists.txt" | while read file; do
          echo "Parcheando: $file"
          sed -i 's/-Werror//g; s/add_compile_options.*-Werror.*//g' "$file"
        done
        
        # Parchear también archivos .cmake
        find . -path "*/picoquic/*" -name "*.cmake" | while read file; do
          echo "Parcheando: $file"
          sed -i 's/-Werror//g' "$file"
        done

    # 6. Configurar con Meson (CORREGIDO CON strip)
    - name: Configurar con Meson
      run: |
        echo "=== Configurando con Meson ==="
        
        # Verificar que strip existe
        echo "Verificando binarios de herramientas:"
        which arm-linux-gnueabi-gcc
        which arm-linux-gnueabi-g++
        which arm-linux-gnueabi-strip || echo "WARNING: strip no encontrado"
        
        # Crear archivo de cross-compilación COMPLETO
        cat > cross-arm.txt << 'EOF'
        [binaries]
        c = 'arm-linux-gnueabi-gcc'
        cpp = 'arm-linux-gnueabi-g++'
        ar = 'arm-linux-gnueabi-ar'
        strip = 'arm-linux-gnueabi-strip'
        pkgconfig = 'pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = 'armv7'
        endian = 'little'
        
        [built-in options]
        c_args = ['-march=armv7-a', '-w', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        cpp_args = ['-march=armv7-a', '-w', '-I/usr/include', '-I/usr/arm-linux-gnueabi/include']
        EOF
        
        echo "=== Archivo de cross-compilación creado ==="
        cat cross-arm.txt
        
        # Configurar con opciones MÍNIMAS
        echo "=== Ejecutando meson setup ==="
        meson setup build \
          --cross-file cross-arm.txt \
          -Dwarning_level=0 \
          -Dwerror=false \
          -Dbuildtype=debug 2>&1 | tail -50

    # 7. Compilar proyecto (CON MÁS DEBUG)
    - name: Compilar proyecto
      run: |
        echo "=== Compilando ==="
        
        # Mostrar contenido del directorio build
        echo "=== Contenido de build/ antes de compilar ==="
        ls -la build/ 2>/dev/null || echo "Directorio build no existe"
        
        # Intentar compilar
        if meson compile -C build 2>&1; then
          echo "✅ Compilación exitosa"
        else
          echo "⚠️  Primero intento falló, intentando con ninja directamente..."
          cd build && ninja -k 5 2>&1 | tail -100 || echo "Continuando..."
        fi
        
        # Verificar si se crearon binarios
        echo "=== Verificando binarios creados ==="
        find build/ -type f -executable 2>/dev/null || echo "No se encontraron ejecutables"

    # 8. Verificar resultado (MÁS ROBUSTO)
    - name: Verificar binarios
      run: |
        echo "=== Verificando binarios ==="
        
        # Buscar cualquier binario que pueda ser slipstream
        echo "=== Buscando ejecutables en build/ ==="
        find build/ -type f -executable -name "*slipstream*" -o -name "*client*" -o -name "*server*" 2>/dev/null
        
        # Si encontramos algún binario
        if find build/ -type f -executable -name "*" 2>/dev/null | grep -q "."; then
          echo "✅ Se encontraron ejecutables"
          
          # Crear directorio para binarios
          mkdir -p slipstream-bin
          
          # Copiar todos los ejecutables encontrados
          find build/ -type f -executable -name "*" -exec cp {} slipstream-bin/ \; 2>/dev/null
          
          echo "=== Binarios copiados ==="
          ls -la slipstream-bin/
          
          # Verificar arquitectura
          for bin in slipstream-bin/*; do
            if [ -f "$bin" ]; then
              echo "=== ARQUITECTURA de $(basename $bin) ==="
              file "$bin"
            fi
          done
          
          # Crear paquete
          tar -czf slipstream-arm32.tar.gz slipstream-bin/
          echo "✅ Paquete creado: slipstream-arm32.tar.gz"
        else
          echo "❌ No se encontraron binarios ejecutables"
          echo "=== ÚLTIMOS ERRORES ==="
          if [ -f "build/meson-logs/meson-log.txt" ]; then
            tail -200 build/meson-logs/meson-log.txt
          else
            echo "No hay archivo de log"
          fi
          
          # Mostrar estructura del directorio build
          echo "=== Estructura de build/ ==="
          find build/ -type f -name "*.o" -o -name "*.a" -o -name "*.so" 2>/dev/null | head -20
          
          exit 1
        fi

    # 9. Subir binarios
    - name: Subir binarios
      uses: actions/upload-artifact@v4
      with:
        name: slipstream-arm32
        path: |
          slipstream-arm32.tar.gz
        retention-days: 90
